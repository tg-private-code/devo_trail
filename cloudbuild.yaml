substitutions:
  _DBT_FLAGS: "" # Default value is an empty string

steps:
  # Use a single Python-based step and install dbt-bigquery via pip to avoid GHCR pulls
  - name: 'python:3.11'
    entrypoint: 'bash'
    env:
      - "PROJECT_ID=$PROJECT_ID"
    args:
      - -lc
      - |
        set -euo pipefail
        python --version
        pip install --no-cache-dir --upgrade pip
        pip install --no-cache-dir 'dbt-bigquery~=1.8'
        dbt --version
        echo 'PWD:' $(pwd)
        echo 'Tree:' && ls -R
        echo 'List models dir:' && find models -maxdepth 3 -type f -print || true
        echo 'Show sources dbt sees:'
        dbt ls --profiles-dir . --target ci --resource-type source || true
        dbt parse --profiles-dir . --target ci
        dbt debug --profiles-dir . --target ci
        dbt build $_DBT_FLAGS --profiles-dir . --target ci

options:
  logging: CLOUD_LOGGING_ONLY
